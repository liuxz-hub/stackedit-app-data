# 一、SPI驱动框架
## 1、SPI 主机驱动
SPI 主机驱动的核心就是申请 `spi_master`，然后初始化 `spi_master`，最后向 Linux 内核注册 `spi_master`。  
1、 spi_master 申请与释放  
`spi_alloc_master`函数用于申请 `spi_master`，函数原型如下：  
```
struct spi_master *spi_alloc_master(struct device *dev, unsigned size)
```
函数参数和返回值含义如下：
dev：设备，一般是 `platform_device` 中的 dev 成员变量。  
size： 私有数据大小，可以通过 `spi_master_get_devdata` 函数获取到这些私有数据。  
返回值： 申请到的 `spi_master`。  

`spi_master` 的释放通过 `spi_master_put` 函数来完成，当我们删除一个 SPI 主机驱动的时候就  
需要释放掉前面申请的 `spi_master`， `spi_master_put`函数原型如下：  
```
void spi_master_put(struct spi_master *master)  
```
函数参数和返回值含义如下：  master：要释放的 spi_master。  

2、 spi_master 的注册与注销

当 `spi_master` 初始化完成以后就需要将其注册到 Linux 内核， `spi_master` 注册函数为`spi_register_master`，函数原型如下：  
```
int spi_register_master(struct spi_master *master)  
```
函数参数和返回值含义如下：  
master：要注册的 spi_master。  
返回值： 0，成功；负值，失败。  

I.MX6U 的 SPI 主机驱动会采用 `spi_bitbang_start` 这个 API 函数来完成 `spi_master` 的注册，  
`spi_bitbang_start` 函数内部其实也是通过调用 `spi_register_master` 函数来完成 `spi_master `的注册。  

如果要注销 spi_master 的话可以使用 `spi_unregister_master` 函数，此函数原型为：  
```
void spi_unregister_master(struct spi_master *master)  
```
函数参数和返回值含义如下：  master：要注销的 spi_master。  

如果使用 `spi_bitbang_start` 注册 `spi_master` 的话就要使用 `spi_bitbang_stop` 来注销掉  
spi_master。

## 2、SPI 设备驱动
`spi_driver` 初始化完成以后需要向 Linux 内核注册， `spi_driver` 注册函数为 `spi_register_driver`，函数原型如下： 
``` 
int spi_register_driver(struct spi_driver *sdrv)  
```
函数参数和返回值含义如下：  
sdrv： 要注册的 spi_driver。  
返回值： 0，注册成功；赋值，注册失败。  

注销 SPI 设备驱动以后也需要注销掉前面注册的 `spi_driver`，使用 `spi_unregister_driver` 函数完成 `spi_driver` 的注销，函数原型如下：  
```
void spi_unregister_driver(struct spi_driver *sdrv)  
```
函数参数和返回值含义如下：  sdrv： 要注销的 spi_driver。









# 二、SPI 驱动编写
## 1、修改设备树
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTIwNzQzNzk0NywtMTcwOTcyMjAxMywtMj
AwNzU2NzkyOV19
-->
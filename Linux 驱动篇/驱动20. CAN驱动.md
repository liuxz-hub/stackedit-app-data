# 一、CAN协议简介
CAN 的全称为 Controller Area Network，也就是控制局域网络。

## 1.1、CAN应用场合
CAN应用目前除了汽车电子以也广泛应用于工业自动化、医疗、工业和船舶等领域。

以汽车电子为例，汽车上有空调、车门、发动机、大量传感器等，这些部件都是通过 `CAN 总线`连在一起形成一个网络，车载网络结构如图：

![输入图片说明](/imgs/2025-08-02/3WUZYtUkAmGl0Zju.png)
各个单元通过 CAN 总线连接在一起，每个单元都是独立的 CAN 节点。同一个 CAN 网络中所有单元的通信速度必须一致，不同的网络之间通信速度可以不同。 比如图 中 125Kbps 的 CAN 网络下所有的节点速度都是 125Kbps 的，整个网络由一个网关与其他的网络连接。

## 1.2、CAN特点
### 1.2.1、多主控制  
1、在总线空闲时，所有单元都可以发送消息（多主控制）

2、两个以上的单元同时开始发送消息时，根据标识符（Identifier 以下称为 ID）决定优先级。 ID 并不是表示发送的目的地址，而是表示访问总线的消息的优先级

3、两个以上的单元同时开始发送消息时，对各消息 ID 的每个位进行逐个仲裁比较。仲裁获胜（被判定为优先级最高）的单元可继续发送消息，仲裁失利的单元则立刻停止发送而进行接收工作。

### 1.2.2、系统的柔软性
与总线相连的单元没有类似于“地址”的信息。因此在总线上增加单元时，连接在总线上的其它单元的软硬件及应用层都不需要改变。

### 1.2.3、通信速度快，距离远
最高 1Mbps（距离小于 40M），最远可达 10KM（速率低于 5Kbps）。  

### 1.2.4、具有错误检测、错误通知和错误恢复功能  
所有单元都可以检测错误（错误检测功能），检测出错误的单元会立即同时通知其他所有单元（错误通知功能），正在发送消息的单元一旦检测出错误，会强制结束当前的发送。强制结束发送的单元会不断反复地重新发送此消息直到成功发送为止（错误恢复功能）。 
 
### 1.2.5、故障封闭功能  
CAN 可以判断出错误的类型是总线上暂时的数据错误（如外部噪声等）还是持续的数据错误（如单元内部故障、驱动器故障、断线等）。由此功能，当总线上发生持续数据错误时，可将引起此故障的单元从总线上隔离出去。  

### 1.2.6、连接节点多  
CAN 总线是可同时连接多个单元的总线。可连接的单元总数理论上是没有限制的。但实际上可连接的单元数受总线上的时间延迟及电气负载的限制。降低通信速度，可连接的单元数增加；提高通信速度，则可连接的单元数减少。

## 1.3、CAN电器属性
CAN 总线使用两根线来连接各个单元： `CAN_H` 和 `CAN_L`， CAN 控制器通过判断这两根  
线上的`电位差`来得到总线电平， CAN 总线电平分为`显性电平`和`隐性电平`两种。

|  CAN_H  | CAN_L |  电位差  |  电平类型  | 逻辑值|
|-------|-----|-------|-------|----|
|3.5V|1.5V|2V|显性电平| 0 |
|2.5V|2.5V|0V|隐性电平| 1 |

![输入图片说明](/imgs/2025-08-02/G8xRqDxL51gJ5tLo.png)

CAN 总线空闲状态的时候一直处于隐性。 CAN 网络中的所有单元都通过 `CAN_H` 和 `CAN_L` 这两根线连接在一起，如图：

![输入图片说明](/imgs/2025-08-02/TUmY1oVaJ12lJyYZ.png)

总线两端要各接一个 120Ω的端接电阻，用于匹配总线阻抗，吸收信号反射及回拨，提高数据通信的抗干扰能力以及可靠性。

-   **CAN** ：
    -   整个报文（包括仲裁段和数据段）使用同一速率（最高1Mbps）
    -    传输速度和总线距离有关，总线距离越短，传输速度越快。

-   **CAN-FD**：
    -   仲裁阶段（报文ID部分）：与CAN相同速率（最高1Mbps），保证向后兼容  
    -   数据阶段：可切换到更高速率（最高可达5Mbps或更高，具体取决于实现）

## 1.4、CAN协议
通过 CAN 总线传输数据是需要按照一定协议进行的， CAN 协议提供了 5 种帧格式来传输数据：数据帧、遥控帧、错误帧、过载帧和帧间隔。
其中数据帧和遥控帧有标准格式和扩展格式两种，标准格式有 11 位标识符(ID)，扩展格式有 29 个标识符(ID)。这 5 中帧的用途见表：

![输入图片说明](/imgs/2025-08-02/78syofIill4MQ5SK.png)

### 1.
以`数据帧`为例进行分析，数据帧由 7 段组成：  
①、帧起始，表示数据帧开始的段。  
②、仲裁段，表示该帧优先级的段。  
③、控制段，表示数据的字节数及保留位的段。  
④、数据段，数据的内容，一帧可发送 0~8 个字节的数据。  
⑤、 CRC 段，检查帧的传输错误的段。  
⑥、 ACK 段，表示确认正常接收的段。  
⑦、帧结束，表示数据帧结束的段。  

数据帧结构如图所示：

![输入图片说明](/imgs/2025-08-02/gRQcbq9W2LkCdYu1.png)

在仲裁帧中`RTR`位显性表示数据帧，隐形表示控制帧。

# 二、仲裁简介

CAN 协议具有仲裁功能，是如何实现的？

-   总线空闲态，最先开始发送消息的单元获得发送权
- 
-   当多个单元同时开始发送时，各发送单元从仲裁段的第一位开始进行仲裁。连续输出显性  
电平最多的单元可继续发送。实现过程如图：

![输入图片说明](/imgs/2025-08-02/3uHZenxWe2Bc1JFV.png)

单元 1 和单元 2 同时开始向总线发送数据，开始部分他们的数据格式是一样的，故无法区分优先级，直到 T 时刻，单元 1 输出隐性电平，而单元 2 输出显性电平， 此时单元 1 仲裁失利，立刻转入接收状态工作，不再与单元 2 竞争，而单元 2 则顺利获得总线使用权，继续发送自己的数据。这就实现了仲裁，让连续发送显性电平多的单元获得总线使用权。

# 二、
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTExMDQ1Mzc3MCw5ODA1ODE4NjcsLTM1NT
M2NjQwNywxOTA0NzUwNDkwLDE4MDMzMDIyNTcsODM0OTMzNTQy
LDM2OTQ2OTU5NywtNjcyMTM2NzA5LDQ2NTAwMjgyOSwtNDY5OD
A4MDgyXX0=
-->